1\. Концепция проекта

«ЕкбТранспорт+» — это расширенная версия MVP-планировщика, которая превращает его в полноценный удобный сервис для жителей Екатеринбурга. Проект решает проблему неудобства планирования поездок, добавляя интеллектуальный поиск по адресам, наглядную визуализацию маршрутов на карте, а также повышая скорость и надёжность работы за счёт кэширования и резервных API. Акцент сделан на улучшении пользовательского опыта и технической устойчивости.



2\. Целевая аудитория и роли

Гость (основная роль): Любой пользователь без регистрации. Может искать маршруты с помощью умного поиска, видеть их на карте, выбирать альтернативные варианты.



Администратор: Управляет системой через Django Admin: просматривает аналитику (логи API, популярные маршруты), очищает кэш, переключает источники данных.



3\. Схема данных (сущности)

Для расширения функционала вводятся три новые ключевые модели:



Модель 1: CachedRoute (Кэшированный маршрут)



hash\_key (CharField, unique=True, db\_index): Уникальный хэш, сформированный из параметров запроса (координаты начала, конца, время). Используется для быстрого поиска в кэше.



route\_data (JSONField): Полный JSON-ответ от внешнего API (2GIS/TomTom) с маршрутами и геометрией.



created\_at (DateTimeField, auto\_now\_add=True): Время создания записи.



expires\_at (DateTimeField): Время истечения срока жизни записи (например, через 30 минут для данных о пробках).



Назначение: Значительно ускоряет повторные одинаковые запросы, снижает нагрузку на внешние API.



Модель 2: SearchHistory (История поиска для аналитики)



start\_query (CharField): Исходный текстовый запрос пользователя ("жд вокзал").



end\_query (CharField): Конечный текстовый запрос.



start\_coords (CharField): Фактические координаты начала, полученные после геокодинга.



end\_coords (CharField): Фактические координаты конца.



timestamp (DateTimeField, auto\_now\_add=True): Время запроса.



is\_successful (BooleanField): Успешен ли был поиск.



Назначение: Сбор анонимных данных для анализа популярности маршрутов и выявления проблем в работе геокодера.



Модель 3: ApiLog (Расширенный лог работы API)



provider (CharField): Имя использованного API (2gis\_geocode, 2gis\_route, tomtom\_route).



request\_params (TextField): Сжатые параметры запроса.



response\_status (IntegerField): HTTP-статус.



response\_time\_ms (FloatField): Время ответа в миллисекундах.



timestamp (DateTimeField, auto\_now\_add=True): Момент запроса.



was\_cached (BooleanField, default=False): Был ли ответ отдан из кэша.



Назначение: Детальный мониторинг производительности и стабильности всех внешних интеграций, учёт квот.



4\. Ключевой функционал (User Stories)

Поиск с автодополнением и картой: Пользователь начинает вводить "пл. 1905" в поле "Откуда". Система предлагает варианты ("пл. 1905 года (Екатеринбург)"). После выбора точек и нажатия "Найти", система показывает 2-3 лучших маршрута не только списком, но и проложив их линию на интерактивной карте, где видны пешие участки и остановки транспорта.



Выбор альтернативного маршрута: Пользователь видит самый быстрый вариант (например, на автобусе). Нажав на вкладку "Меньше пересадок" или "Только трамваи", он получает другие варианты, также отображённые на карте. Система использует кэш для мгновенного переключения.



Аналитика популярных запросов (для админа): Администратор заходит в раздел Analytics в админ-панели и видит сводный дашборд: "Топ-10 запрашиваемых маршрутов за неделю", "Среднее время ответа 2GIS API", "Процент запросов, отданных из кэша". Это помогает понять нагрузку.



Автоматический переход на резервный API: При запросе маршрута, если основной API 2GIS не отвечает или возвращает критическую ошибку, система автоматически и незаметно для пользователя делает запрос к резервному TomTom Routing API для построения автомобильного/пешего маршрута и корректно обрабатывает ответ.



5\. Технический стек и интеграции

Бэкенд: Django 5.x, Django REST Framework (для внутреннего API карт), django-redis (для кэширования).



Фронтенд: HTML, CSS (Bootstrap), JS (Vanilla для карт), Django Templates.



База данных: PostgreSQL (для работы с JSONField и аналитических запросов).



Внешние API:



2GIS Public Transport API (v2.0): Основной источник данных об общественном транспорте.



TomTom Routing API (v1): Резервный источник для маршрутов и основной источник для геокодинга (преобразования "ул. Малышева, 5" в координаты через TomTom Search API). Бесплатный лимит достаточен для MVP+.



Картографический API: На выбор - Leaflet.js (бесплатный, открытый) с подложкой OpenStreetMap. Нужен для отрисовки линий маршрута (geometry из ответа 2GIS).



Аналитика и инфраструктура:



pandas + matplotlib: Для генерации простых графиков топовых маршрутов прямо в админ-панели на основе модели SearchHistory.



celery + redis (опционально, если останется время): Для фоновой периодической очистки устаревшего кэша (CachedRoute) и подготовки агрегированной аналитики.



6\. Соответствие реализации плану



Изменения в ходе реализации (будут фиксироваться здесь):



Поле для заметок о любых отклонениях от плана, заменах API или изменениях в моделях данных.

