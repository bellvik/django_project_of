<style>
    /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã */
    #route-form .form-group {
        margin-bottom: 1.5rem;
        position: relative; /* –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–µ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ */
    }

    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-top: none; /* –£–±–∏—Ä–∞–µ–º –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –ø–ª–∞–≤–Ω–æ —Å–æ–µ–¥–∏–Ω—è—Ç—å—Å—è —Å –ø–æ–ª–µ–º */
        z-index: 99; /* –ü–æ–≤–µ—Ä—Ö –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        top: 100%; /* –ü—Ä—è–º–æ –ø–æ–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ */
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background-color: #fff;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* –õ–µ–≥–∫–∞—è —Ç–µ–Ω—å –¥–ª—è –æ–±—ä–µ–º–∞ */
    }
    .autocomplete-items div {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f1f1f1;
        font-size: 0.9rem;
    }
    .autocomplete-items div:hover {
        background-color: #007bff; /* –¶–≤–µ—Ç Bootstrap primary */
        color: white;
    }
    .autocomplete-items div strong {
        font-weight: normal;
    }
    .autocomplete-items:empty {
        display: none;
    }
</style>
<h2>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ–µ–∑–¥–æ–∫ –ï–∫–±–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç+</h2>

{% if use_real_api %}
<div class="alert alert-info">
    <strong>–†–µ–∂–∏–º —Ä–µ–∞–ª—å–Ω—ã—Ö API:</strong> –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è TomTom –¥–ª—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
</div>
{% else %}
<div class="alert alert-warning">
    <strong>–†–µ–∂–∏–º –∑–∞–≥–ª—É—à–µ–∫:</strong> –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
</div>
{% endif %}


<form method="get" id="route-form">
     <div class="form-group autocomplete"> <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å autocomplete -->
        <label for="start-point">{{ form.start_point.label }}</label>
        {{ form.start_point }}
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –í–ù–£–¢–†–ò —ç–ª–µ–º–µ–Ω—Ç–∞ —Å position: relative -->
        <div id="start-autocomplete" class="autocomplete-items"></div>
    </div>

    <!-- –ü–æ–ª–µ "–ö—É–¥–∞" —Å –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º -->
    <div class="form-group autocomplete"> <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å autocomplete -->
        <label for="end-point">{{ form.end_point.label }}</label>
        {{ form.end_point }}
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –í–ù–£–¢–†–ò —ç–ª–µ–º–µ–Ω—Ç–∞ —Å position: relative -->
        <div id="end-autocomplete" class="autocomplete-items"></div>
    </div>

    <!-- –ü–æ–ª–µ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –º–∞—Ä—à—Ä—É—Ç–∞ -->
    <div class="form-group">
        <label for="travel-mode">{{ form.travel_mode.label }}</label>
        {{ form.travel_mode }}
    </div>

    <button type="submit" class="btn btn-primary">–ù–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç</button>
</form>

{% if error_message %}
<div class="alert alert-danger">{{ error_message }}</div>
{% endif %}

{% if geocoded_points %}
<div class="card mt-3">
    <div class="card-header">
        <strong>–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏:</strong>
    </div>
    <div class="card-body">
        <p><strong>–û—Ç–∫—É–¥–∞:</strong> {{ geocoded_points.start.address }} 
        ({{ geocoded_points.start.lat|floatformat:4 }}, {{ geocoded_points.start.lon|floatformat:4 }})</p>
        <p><strong>–ö—É–¥–∞:</strong> {{ geocoded_points.end.address }}
        ({{ geocoded_points.end.lat|floatformat:4 }}, {{ geocoded_points.end.lon|floatformat:4 }})</p>
        <small class="text-muted">–ò—Å—Ç–æ—á–Ω–∏–∫: {{ geocoded_points.start.source }}</small>
    </div>
</div>
{% endif %}

{% if routes %}
<h3 class="mt-4">–ù–∞–π–¥–µ–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: {{ routes|length }}</h3>

{% for route in routes %}
<div class="card mt-3">
    <div class="card-header d-flex justify-content-between">
        <span>
            <strong>–ú–∞—Ä—à—Ä—É—Ç {{ forloop.counter }} {{ route.mode_icon }}</strong>
            <span class="badge bg-secondary">{{ route.mode_display }}</span>
            {% if route.source %}
                <span class="badge bg-info">{{ route.source }}</span>
            {% endif %}
        </span>
        <!-- 1. –ó–∞–º–µ–Ω—è–µ–º adjusted_time –Ω–∞ total_time -->
        <span class="badge bg-primary">–í—Ä–µ–º—è: {{ route.total_time }} –º–∏–Ω</span>
    </div>
    <div class="card-body">
        <!-- 2. –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–≤–æ–¥ –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–µ—Ä–∂–∫–µ -->
        <p>
            <strong>–û–±—â–µ–µ –≤—Ä–µ–º—è –≤ –ø—É—Ç–∏:</strong> {{ route.total_time }} –º–∏–Ω
            {% if route.travel_mode == 'car' and route.traffic_delay > 0 %}
                <small class="text-muted">(–∑–∞–¥–µ—Ä–∂–∫–∞ –∏–∑-–∑–∞ –ø—Ä–æ–±–æ–∫: +{{ route.traffic_delay }} –º–∏–Ω)</small>
            {% endif %}
        </p>
        <p><strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</strong> {{ route.total_distance }} –º ({{ route.total_distance|divisibleby:1000|yesno:"–∫–º,–º" }})</p>
        
        <!-- 3. –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–ú —ç—Ç–æ—Ç —Å–ª–æ–º–∞–Ω–Ω—ã–π –±–ª–æ–∫ –Ω–∞ –Ω–æ–≤—ã–π -->
        {% if route.travel_mode == 'car' and route.traffic_delay > 0 %}
        <div class="alert alert-warning">
            <strong>–í–Ω–∏–º–∞–Ω–∏–µ, –ø—Ä–æ–±–∫–∏!</strong> –ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–π –¥–æ—Ä–æ–∂–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.
        </div>
        {% endif %}
        <!-- –ö–æ–Ω–µ—Ü –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ -->
        
        <h5>–≠—Ç–∞–ø—ã –º–∞—Ä—à—Ä—É—Ç–∞:</h5>
        <ul class="list-group">
            {% for segment in route.segments %}
            <li class="list-group-item">
                {% if segment.type == 'walk' %}
                    <span class="badge bg-success">üö∂ –ü–µ—à–∫–æ–º</span>
                    {{ segment.time }} –º–∏–Ω
                    <small class="text-muted">‚Äì {{ segment.details.text|default:"–ü–µ—à–∏–π —É—á–∞—Å—Ç–æ–∫" }}</small>
                {% elif segment.type == 'transport' %}
                    {% if route.travel_mode == 'car' %}
                        <span class="badge bg-warning">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å</span>
                    {% elif route.travel_mode == 'bicycle' %}
                        <span class="badge bg-info">üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥</span>
                    {% else %}
                        <span class="badge bg-primary">üöå –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</span>
                    {% endif %}
                    {{ segment.time }} –º–∏–Ω
                    <small class="text-muted">
                        ‚Äì {{ segment.details.route_name|default:"–û—Å–Ω–æ–≤–Ω–æ–π —É—á–∞—Å—Ç–æ–∫" }}
                        {% if segment.details.distance %}
                            ({{ segment.details.distance }})
                        {% endif %}
                    </small>
                {% else %}
                    <span class="badge bg-secondary">{{ segment.type }}</span>
                    {{ segment.time }} –º–∏–Ω
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endfor %}
{% endif %}

<script>
function setupAutocomplete(inputId, itemsContainerId) {
    const input = document.getElementById(inputId);
    const itemsContainer = document.getElementById(itemsContainerId);

    // –û–¢–õ–ê–î–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–π–¥–µ–Ω –ª–∏ —ç–ª–µ–º–µ–Ω—Ç
    if (!input) {
        console.error('–ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç input —Å id:', inputId);
        return;
    }
    if (!itemsContainer) {
        console.error('–ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç container —Å id:', itemsContainerId);
        return;
    }

    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è:', inputId);

    input.addEventListener('input', function(e) {
        const query = this.value.trim();
        console.log('–í–≤–æ–¥:', query);

        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        itemsContainer.innerHTML = '';

        if (query.length < 2) {
            console.log('–ó–∞–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π');
            return;
        }

        // –î–µ–±–∞—É–Ω—Å–∏–Ω–≥
        clearTimeout(window.autocompleteTimeout);
        window.autocompleteTimeout = setTimeout(() => {
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è:', query);
            fetch(`/api/autocomplete/?q=${encodeURIComponent(query)}`)
                .then(response => {
                    console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç API:', data);
                    if (data.results && data.results.length > 0) {
                        showAutocompleteItems(data.results, itemsContainer, input);
                    } else {
                        console.log('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤');
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è:', error));
        }, 300);
    });

    function showAutocompleteItems(results, container, input) {
        results.forEach(item => {
            const itemElement = document.createElement('div');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º .label, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å
            itemElement.textContent = item.label; // –ú–µ–Ω—è–µ–º innerHTML –Ω–∞ textContent –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            itemElement.addEventListener('click', function() {
                console.log('–í—ã–±—Ä–∞–Ω –≤–∞—Ä–∏–∞–Ω—Ç:', item.value);
                input.value = item.value;
                container.innerHTML = ''; // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
            });
            container.appendChild(itemElement);
        });
        console.log('–ü–æ–∫–∞–∑–∞–Ω–æ –ø–æ–¥—Å–∫–∞–∑–æ–∫:', results.length);
    }

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function(e) {
        if (e.target !== input && e.target !== itemsContainer) {
            itemsContainer.innerHTML = '';
        }
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è...');
    setupAutocomplete('start-point', 'start-autocomplete');
    setupAutocomplete('end-point', 'end-autocomplete');
});
</script>