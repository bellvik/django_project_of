<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–∫–±–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç+ - –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ–µ–∑–¥–æ–∫</title>
    

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    
    <style>
        #route-form .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-top: none;
            z-index: 1000;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .autocomplete-items div {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            font-size: 0.9rem;
        }
        .autocomplete-items div:hover {
            background-color: #007bff;
            color: white;
        }
        .autocomplete-items:empty {
            display: none;
        }
        
        .route-details {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-top: 10px;
            border-radius: 0 5px 5px 0;
        }
        
        .segment-item {
            padding: 8px 0;
            border-bottom: 1px dashed #dee2e6;
        }
        
        .segment-item:last-child {
            border-bottom: none;
        }
        
        .badge-transport {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        
        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        

        @media (max-width: 768px) {
            #map {
                height: 350px;
            }
        }
        
        @media (max-width: 576px) {
            #map {
                height: 300px;
            }
        }
        

        .accordion-button:not(.collapsed) {
            background-color: #e7f1ff;
        }
        

        .step-icon {
            font-size: 1.2em;
            margin-right: 8px;
        }
    </style>
</head>
<body class="container mt-4">

    <div class="row">
        <div class="col-12">
            <h1 class="mb-3">üó∫Ô∏è –ï–∫–±–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç+ - –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ–µ–∑–¥–æ–∫</h1>
            
            {% if use_real_api %}
            <div class="alert alert-info">
                <strong>–†–µ–∂–∏–º —Ä–µ–∞–ª—å–Ω—ã—Ö API:</strong> –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è TomTom –¥–ª—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
            </div>
            {% else %}
            <div class="alert alert-warning">
                <strong>–†–µ–∂–∏–º –∑–∞–≥–ª—É—à–µ–∫:</strong> –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            </div>
            {% endif %}
        </div>
    </div>
    <div class="row">
        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üîç –ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–∞</h5>
                </div>
                <div class="card-body">
                    <form method="get" id="route-form">
                        <div class="form-group autocomplete">
                            <label for="start-point" class="form-label">{{ form.start_point.label }}</label>
                            {{ form.start_point }}
                            <div id="start-autocomplete" class="autocomplete-items"></div>
                        </div>

                        <div class="form-group autocomplete">
                            <label for="end-point" class="form-label">{{ form.end_point.label }}</label>
                            {{ form.end_point }}
                            <div id="end-autocomplete" class="autocomplete-items"></div>
                        </div>

                        <div class="form-group">
                            <label for="travel-mode" class="form-label">{{ form.travel_mode.label }}</label>
                            {{ form.travel_mode }}
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-route"></i> –ù–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç
                        </button>
                    </form>

                    {% if error_message %}
                    <div class="alert alert-danger mt-3">{{ error_message }}</div>
                    {% endif %}

                    {% if geocoded_points %}
                    <div class="card mt-3">
                        <div class="card-header bg-light">
                            <strong>üìç –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏</strong>
                        </div>
                        <div class="card-body">
                            <p><strong>–û—Ç–∫—É–¥–∞:</strong> {{ geocoded_points.start.address }}</p>
                            <p><strong>–ö—É–¥–∞:</strong> {{ geocoded_points.end.address }}</p>
                            <small class="text-muted">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö: {{ geocoded_points.start.source }}</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            {% if routes %}
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üìã –ù–∞–π–¥–µ–Ω–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤: {{ routes|length }}</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="routesAccordion">
                        {% for route in routes %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" 
                                        type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#collapse{{ forloop.counter }}" 
                                        aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" 
                                        aria-controls="collapse{{ forloop.counter }}"
                                        onclick="showRouteOnMap({{ forloop.counter0 }})">
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <div>
                                            <span class="me-2">{{ route.icon }}</span>
                                            <strong>–ú–∞—Ä—à—Ä—É—Ç {{ forloop.counter }}</strong>
                                            <span class="badge bg-secondary ms-2">{{ route.mode_display }}</span>
                                            {% if route.source %}
                                                <span class="badge bg-info ms-1">{{ route.source }}</span>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <span class="badge bg-primary">‚è±Ô∏è {{ route.total_time }} –º–∏–Ω</span>
                                            <span class="badge bg-success ms-1">üìè {{ route.total_distance|floatformat:0 }} –º</span>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse{{ forloop.counter }}" 
                                 class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                                 aria-labelledby="heading{{ forloop.counter }}" 
                                 data-bs-parent="#routesAccordion">
                                <div class="accordion-body">
                                    <!-- –î–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞ -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <h6>üìä –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h6>
                                            <ul class="list-unstyled">
                                                <li><strong>–í—Ä–µ–º—è –≤ –ø—É—Ç–∏:</strong> {{ route.total_time }} –º–∏–Ω</li>
                                                <li><strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</strong> {{ route.total_distance|floatformat:0 }} –º</li>
                                                {% if route.travel_mode == 'car' and route.traffic_delay > 0 %}
                                                <li><strong>–ó–∞–¥–µ—Ä–∂–∫–∞ –∏–∑-–∑–∞ –ø—Ä–æ–±–æ–∫:</strong> <span class="text-warning">+{{ route.traffic_delay }} –º–∏–Ω</span></li>
                                                {% endif %}
                                                <li><strong>–¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞:</strong> {{ route.mode_display }}</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>üìç –¢–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞:</h6>
                                            <ul class="list-unstyled">
                                                <li><strong>–ù–∞—á–∞–ª–æ:</strong> {{ route.start_address|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</li>
                                                <li><strong>–ö–æ–Ω–µ—Ü:</strong> {{ route.end_address|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <h6>üö∂ –≠—Ç–∞–ø—ã –º–∞—Ä—à—Ä—É—Ç–∞:</h6>
                                    <div class="route-details">
                                        {% for segment in route.segments %}
                                        <div class="segment-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    {% if segment.type == 'walk' %}
                                                        <span class="badge bg-success badge-transport">üö∂ –ü–µ—à–∫–æ–º</span>
                                                    {% elif segment.type == 'transport' %}
                                                        {% if route.travel_mode == 'car' %}
                                                            <span class="badge bg-warning badge-transport">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å</span>
                                                        {% elif route.travel_mode == 'bicycle' %}
                                                            <span class="badge bg-info badge-transport">üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥</span>
                                                        {% else %}
                                                            <span class="badge bg-primary badge-transport">üöå –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</span>
                                                        {% endif %}
                                                    {% endif %}
                                                    
                                                    <span class="ms-2">
                                                        {% if segment.details.route_name %}
                                                            <strong>{{ segment.details.route_name }}</strong>
                                                        {% endif %}
                                                        {% if segment.details.text %}
                                                            {{ segment.details.text }}
                                                        {% endif %}
                                                    </span>
                                                    
                                                    {% if segment.details.distance %}
                                                    <div class="mt-1">
                                                        <small class="text-muted">
                                                            <strong>–ü—Ä–æ—Ç—è–∂–µ–Ω–Ω–æ—Å—Ç—å:</strong> 
                                                            {{ segment.details.distance }}
                                                        </small>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <span class="badge bg-dark">{{ segment.time }} –º–∏–Ω</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    {% if route.instructions %}
                                    <h6 class="mt-3">üìù –ü–æ—à–∞–≥–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç:</h6>
                                    <div class="list-group">
                                        {% for step in route.instructions %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">–®–∞–≥ {{ forloop.counter }}</h6>
                                                <small>{{ step.time }} –º–∏–Ω ({{ step.distance }} –º)</small>
                                            </div>
                                            <p class="mb-1">
                                                {% if step.direction %}
                                                    <strong>{{ step.direction }}</strong><br>
                                                {% endif %}
                                                {% if step.street %}
                                                    <small class="text-muted">–£–ª–∏—Ü–∞: {{ step.street }}</small>
                                                {% endif %}
                                            </p>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üó∫Ô∏è –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞</h5>
                </div>
                <div class="card-body">
                    <div id="map"></div>
                    <small class="text-muted mt-2 d-block">
                        –ö–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–µ. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç –≤ —Å–ø–∏—Å–∫–µ –≤—ã—à–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ.
                    </small>
                </div>
            </div>
        </div>
    </div>

 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
  
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    
    <script>

        let map = L.map('map').setView([56.838011, 60.597465], 12); // –¶–µ–Ω—Ç—Ä - –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥
    
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        

        let routeLayers = [];
        let markers = [];
        

        const routesData = JSON.parse('{{ routes_json|escapejs }}' || '[]');
        const geocodedPoints = JSON.parse('{{ geocoded_points_json|escapejs }}' || '{}');
        function showRouteOnMap(routeIndex) {
            clearMap();
            
            if (routesData.length > 0 && routeIndex < routesData.length) {
                const route = routesData[routeIndex];
                const routeCoordinates = route.coordinates || [];
                if (geocodedPoints.start && geocodedPoints.end) {
                    const startMarker = L.marker(
                        [geocodedPoints.start.lat, geocodedPoints.start.lon],
                        {
                            icon: L.divIcon({
                                className: 'route-marker-start',
                                html: '<div style="background-color:#28a745; width:12px; height:12px; border-radius:50%;"></div>'
                            })
                        }
                    ).addTo(map);
                    
                    startMarker.bindPopup(`
                        <div class="route-info-window">
                            <strong>üìç –ù–∞—á–∞–ª–æ –º–∞—Ä—à—Ä—É—Ç–∞</strong><br>
                            ${geocodedPoints.start.address || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}<br>
                            <small>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${geocodedPoints.start.lat?.toFixed(4) || 'N/A'}, ${geocodedPoints.start.lon?.toFixed(4) || 'N/A'}</small>
                        </div>
                    `);
                    markers.push(startMarker);
                    const endMarker = L.marker(
                        [geocodedPoints.end.lat, geocodedPoints.end.lon],
                        {
                            icon: L.divIcon({
                                className: 'route-marker-end',
                                html: '<div style="background-color:#dc3545; width:12px; height:12px; border-radius:50%;"></div>'
                            })
                        }
                    ).addTo(map);
                    
                    endMarker.bindPopup(`
                        <div class="route-info-window">
                            <strong>üèÅ –ö–æ–Ω–µ—Ü –º–∞—Ä—à—Ä—É—Ç–∞</strong><br>
                            ${geocodedPoints.end.address || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}<br>
                            <small>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${geocodedPoints.end.lat?.toFixed(4) || 'N/A'}, ${geocodedPoints.end.lon?.toFixed(4) || 'N/A'}</small>
                        </div>
                    `);
                    markers.push(endMarker);
                }
                
                if (routeCoordinates.length > 0) {

                    route.segments?.forEach((segment, segmentIndex) => {
                        const segmentCoords = routeCoordinates[segmentIndex] || [];
                        
                        if (segmentCoords.length > 0) {
                            let color = '#007bff'; // —Å–∏–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                            
                            if (segment.type === 'walk') {
                                color = '#28a745'; // –∑–µ–ª–µ–Ω—ã–π –¥–ª—è –ø–µ—à–∏—Ö —É—á–∞—Å—Ç–∫–æ–≤
                            } else if (segment.type === 'transport') {
                                if (route.travel_mode === 'car') {
                                    color = '#ff3333'; // –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –∞–≤—Ç–æ
                                } else if (route.travel_mode === 'bicycle') {
                                    color = '#17a2b8'; // –≥–æ–ª—É–±–æ–π –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
                                }
                            }
                            
                            const polyline = L.polyline(segmentCoords, {
                                color: color,
                                weight: 4,
                                opacity: 0.7,
                                lineJoin: 'round'
                            }).addTo(map);
                            
                            let popupContent = '';
                            if (segment.type === 'walk') {
                                popupContent = `üö∂ –ü–µ—à–∫–æ–º: ${segment.time} –º–∏–Ω<br>${segment.details?.text || ''}`;
                            } else if (segment.type === 'transport') {
                                const vehicle = route.travel_mode === 'car' ? 'üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å' : 
                                              route.travel_mode === 'bicycle' ? 'üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥' : 'üöå –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç';
                                popupContent = `${vehicle}: ${segment.time} –º–∏–Ω<br>${segment.details?.route_name || ''}`;
                            }
                            
                            if (popupContent) {
                                polyline.bindPopup(popupContent);
                            }
                            
                            routeLayers.push(polyline);
                        }
                    });
                    const allPoints = routeCoordinates.flat();
                    if (allPoints.length > 0) {
                        const bounds = L.latLngBounds(allPoints);
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                } else {
                    if (geocodedPoints.start && geocodedPoints.end) {
                        const bounds = L.latLngBounds([
                            [geocodedPoints.start.lat, geocodedPoints.start.lon],
                            [geocodedPoints.end.lat, geocodedPoints.end.lon]
                        ]);
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                }
            }
        }
        

        function clearMap() {
            routeLayers.forEach(layer => map.removeLayer(layer));
            markers.forEach(marker => map.removeLayer(marker));
            routeLayers = [];
            markers = [];
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            if (routesData.length > 0) {
                setTimeout(() => {
                    showRouteOnMap(0);
                }, 500);
            }
            
            setupAutocomplete('start-point', 'start-autocomplete');
            setupAutocomplete('end-point', 'end-autocomplete');
        });
        function setupAutocomplete(inputId, itemsContainerId) {
            const input = document.getElementById(inputId);
            const itemsContainer = document.getElementById(itemsContainerId);

            if (!input || !itemsContainer) return;

            input.addEventListener('input', function(e) {
                const query = this.value.trim();
                itemsContainer.innerHTML = '';

                if (query.length < 2) return;

                clearTimeout(window.autocompleteTimeout);
                window.autocompleteTimeout = setTimeout(() => {
                    fetch(`/api/autocomplete/?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.results && data.results.length > 0) {
                                showAutocompleteItems(data.results, itemsContainer, input);
                            }
                        })
                        .catch(error => console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è:', error));
                }, 300);
            });

            function showAutocompleteItems(results, container, input) {
                results.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.textContent = item.label;
                    itemElement.addEventListener('click', function() {
                        input.value = item.value;
                        container.innerHTML = '';
                    });
                    container.appendChild(itemElement);
                });
            }

            document.addEventListener('click', function(e) {
                if (e.target !== input && e.target !== itemsContainer) {
                    itemsContainer.innerHTML = '';
                }
            });
        }
    </script>
</body>
</html>